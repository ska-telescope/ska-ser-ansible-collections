- op: add
  path: /spec/kubeadmConfigSpec/preKubeadmCommands/-
  target:
    kind: KubeadmControlPlane
    name: ${CLUSTER_NAME}-control-plane
  value:
    '/usr/bin/bash /etc/kubernetes/initialise-install-tools.sh >>/tmp/capo-config.log 2>&1'

- op: add
  path: /spec/kubeadmConfigSpec/files/-
  target:
    kind: KubeadmControlPlane
    name: ${CLUSTER_NAME}-control-plane
  value:
    owner: root:root
    path: /etc/kubernetes/initialise-install-tools.sh
    content: |
      #!/usr/bin/bash

      echo ""
      echo "==================================================================="
      echo "Running the cluster initialisation: install prereq tools"
      set -x
      apt update
      apt install -y --allow-change-held-packages gettext-base git ca-certificates net-tools python3 python3-pip
      pip3 install ansible kubernetes
      cd /usr/src && \
      git clone --depth 1 https://gitlab.com/ska-telescope/sdi/ska-ser-ansible-collections.git \
        --recurse-submodules \
        --branch ${COLLECTIONS_BRANCH}
      cd ska-ser-ansible-collections
      echo -e "[management-cluster]\nclusterapi\n127.0.0.1\n" > ansible_hosts

      export THIS_BASE=$(pwd)
      export ENVIRONMENT=stfc-techops
      export PLAYBOOKS_HOSTS=clusterapi
      cat <<EOF > run-play.sh
      #!/usr/bin/bash
      echo "run-play.sh args are: \$*"
      cd /usr/src/ska-ser-ansible-collections
      export THIS_BASE=$(pwd)
      export PLAYBOOKS_HOSTS=clusterapi
      export ANSIBLE_COLLECTIONS_PATHS="$THIS_BASE:$HOME/.ansible/collections:/usr/share/ansible/collections"
      export KUBECONFIG="/etc/kubernetes/admin.conf"
      ANSIBLE_CONFIG="$THIS_BASE/datacentres/production/installation/ansible.cfg"
      ansible-playbook \
        --connection=local \
        --inventory 127.0.0.1, \
        --limit 127.0.0.1 \
         --become \
         --extra-vars "capi_cluster=${CLUSTER_NAME}" \
         --extra-vars "capi_kubeconfig=$KUBECONFIG" \
        $THIS_BASE/ansible_collections/ska_collections/clusterapi/playbooks/\$1 \
         --inventory /usr/src/ska-ser-ansible-collections/ansible_hosts \$${@:2}
      EOF
      chmod a+x run-play.sh
      cat run-play.sh

      echo "Finished."
      exit 0
