---

- name: Calculate version vars
  set_fact:
    os_name: "{{ ansible_system | lower }}"
    os_binary: "{% if ansible_facts.architecture == 'x86_64' %}amd64{% else %}unknown{% endif %}"
    os_arch: "{{ ansible_facts.architecture | lower }}"
    k9s_arch: "{{ ansible_facts.architecture | lower }}"

# load shared vars with setup
- name: Include vars
  ansible.builtin.include_vars:
    file: ../setup/defaults/main.yml
  tags: [always]

- name: Load cloud config
  include_vars:
    file: "{{ velero_cloud_config }}"
    name: "velero_ostack_cloud_yaml"

- name: set selected cloud
  set_fact:
    velero_selected_cloud: "{{ velero_ostack_cloud_yaml['clouds'][velero_cloud] }}"

- name: Check if velero exists
  stat:
    path: "{{ velero_exe_dir }}/velero"
  register: stat_velero

- name: Check if the velero version is installed
  command: "{{ velero_exe_dir }}/velero version --client-only"
  changed_when: false
  register: velero_version_check
  ignore_errors: true

- name: velero install
  block:
    - name: set velero_archive fact
      set_fact:
        velero_archive: "velero-{{ velero_version }}-{{ os_name }}-{{ os_binary }}.tar.gz"

    - name: Download velero
      get_url:
        url: "https://github.com/vmware-tanzu/velero/releases/download/{{ velero_version }}/{{ velero_archive }}"
        dest: "/tmp/{{ velero_archive }}"
        mode: "0755"
        tmp_dest: "/tmp/"

    - name: unpack velero
      unarchive:
        src: "/tmp/{{ velero_archive }}"
        include: "velero-{{ velero_version }}-{{ os_name }}-{{ os_binary }}/velero"
        remote_src: true
        dest: "{{ velero_exe_dir }}/"
        mode: "0755"
        extra_opts:
          - "--strip-components=1"
      become: true

    - name: tidy up velero download
      file:
        path: "/tmp/{{ velero_archive }}"
        state: absent

  when: "not stat_velero.stat.exists or
    velero_version_check.stdout.find(velero_version) == -1"

- name: Check Velero is running
  k8s_info:
    api_version: v1
    kind: Deployment
    name: velero
    namespace: velero
  register: velero_controller_check

# https://github.com/Lirt/velero-plugin-for-openstack
- name: Start Velero
  block:

    - name: Start up Velero
      command: |
        {{ velero_exe_dir }}/velero install \
          --provider "community.openstack.org/openstack" \
                  --plugins {{ velero_ostack_plugin_version }} \
                  --bucket {{ velero_bucket }} --no-secret

      changed_when: false
      register: velero_check

    - name: Wait for deploy/velero
      kubernetes.core.k8s_info:
        kind: Deployment
        api_version: v1
        name: velero
        namespace: velero
        wait: true
        wait_sleep: 10
        wait_timeout: 300
        wait_condition:
          type: Available

  # Velero is not started
  when: "not velero_controller_check.resources"

- name: Check Velero BackUpStorageLocation
  k8s_info:
    kind: BackupStorageLocation
    api_version: velero.io/v1
    name: default
    namespace: velero
  register: velero_backuplocation_check

- name: Set Velero backup config
  command: |
    kubectl -n velero set env deployment/velero \
    OS_REGION_NAME="{{ velero_selected_cloud.region_name }}" \
    OS_INTERFACE="{{ velero_selected_cloud.interface }}" \
    OS_AUTH_URL="{{ velero_selected_cloud.auth.auth_url }}" \
    OS_USERNAME="{{ velero_selected_cloud.auth.username }}" \
    OS_PROJECT_ID="{{ velero_selected_cloud.auth.project_id }}" \
    OS_USER_DOMAIN_NAME="{{ velero_selected_cloud.auth.user_domain_name }}" \
    OS_PROJECT_NAME="{{ velero_selected_cloud.auth.project_name }}" \
    OS_PASSWORD="{{ velero_selected_cloud.auth.password }}" \
    OS_IDENTITY_API_VERSION="{{ velero_selected_cloud.identity_api_version }}"
  changed_when: false
  register: velero_check
  # Velero backup is not configured correctly
  when: "not velero_backuplocation_check.resources or
         velero_backuplocation_check.resources[0].status.phase != 'Available'"

- name: Check backup schedule
  command: |
    velero schedule describe {{ velero_schedule_name }}
  changed_when: false
  register: velero_schedule_check
  ignore_errors: true

- name: Set Velero backup schedule
  command: |
    velero schedule create {{ velero_schedule_name }} \
     --schedule="{{ velero_schedule_time }}" \
     --include-cluster-resources=true \
     --snapshot-volumes=false \
     --storage-location default \
     --ttl {{ velero_schedule_ttl }}
  changed_when: false
  register: velero_check
  # Velero backup has not been scheduled
  when: "not velero_schedule_check.rc == 0"

- name: Flush those handlers
  meta: flush_handlers
