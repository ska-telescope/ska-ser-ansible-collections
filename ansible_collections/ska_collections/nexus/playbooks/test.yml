# !/usr/bin/env ansible-playbook
---
- name: Show debug info
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: "Show stack nodes info"
      ansible.builtin.debug:
        var: hostvars[inventory_hostname]
      when: debug

- name: Retrieve defaults but keep the variable hierarchy
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: Retrieve all datacenter values
      ansible.builtin.include_vars:
        file: "{{ inventory_dir }}/group_vars/all.yml"
    - name: Retrieve nexus datacenter values
      ansible.builtin.include_vars:
        file: "{{ inventory_dir }}/group_vars/nexus.yml"

- name: Apply the docker role
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: Docker role
      ansible.builtin.include_role:
        name: ska_collections.docker_base.docker

- name: Check test image not in nexus
  hosts: "{{ target_hosts }}"
  uri:
    url: "{{ nexus_cache_hostname }}/service/rest/v1/search/assets?<ARGS>"
    method: GET
    user: "{{ user }}"
    password: "{{ password }}"
    force_basic_auth: yes
    status_code:
      - 404

- name: Pull test image
  community.docker.docker_image:
    name: hello-world
    source: pull

- name: Check test image appears in nexus
  hosts: "{{ target_hosts }}"
  uri:
    url: "{{ nexus_cache_hostname }}/service/rest/v1/search/assets?<ARGS>"
    method: GET
    user: "{{ user }}"
    password: "{{ password }}"
    force_basic_auth: yes
    status_code:
      - 302
    register: testImage

- name: Delete test image from nexus
  hosts: "{{ target_hosts }}"
  uri:
    url: "{{ nexus_cache_hostname }}/service/rest/v1/asssets/{{ testImage | json_query('items[0].id') }}"
    method: GET
    user: "{{ user }}"
    password: "{{ password }}"
    force_basic_auth: yes
    status_code:
      - 200
    register: second_response_code 
