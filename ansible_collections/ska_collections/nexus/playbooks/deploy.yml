# !/usr/bin/env ansible-playbook
---
- name: Show debug info
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: "Show stack nodes info"
      ansible.builtin.debug: var=hostvars[inventory_hostname]
      when: debug

- name: Retrieve defaults but keep the variable hierarchy
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: Retrieve all datacenter values
      ansible.builtin.include_vars:
        file: "{{ inventory_dir }}/group_vars/all.yml"
    - name: Retrieve nexus datacenter values
      ansible.builtin.include_vars:
        file: "{{ inventory_dir }}/group_vars/nexus.yml"

- name: Apply the common and docker roles
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  tasks:
    - name: Instance common role
      include_role:
        name: ska_collections.instance_common.init

    - name: Docker role
      include_role:
        name: ska_collections.docker_base.docker
  tags:
    - common

- name: Nexus Pre-install
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  # run roles for Nexus install
  tasks:
    - name: Nexus common role
      include_role:
        name: ska_collections.nexus.common
        apply:
          tags:
           - init

# extracted from https://github.com/ansible-ThoTeam/nexus3-oss#example-playbook
# additional configuration of conan proxy - https://help.sonatype.com/repomanager3/formats/conan-repositories
# conan hosted activation - https://issues.sonatype.org/browse/NEXUS-23629
# nexus.conan.hosted.enabled=true in /var/lib/nexus/nexus/nexus-latest/etc/nexus-default.properties
# Nexus config - oss https://github.com/sonatype/nexus-public/blob/master/assemblies/nexus-base-template/src/main/resources/overlay/etc/nexus-default.properties
# https://gitlab.cern.ch/vcs/nexus-cern-apb.git
# Nexus section
# nexus-edition=nexus-oss-edition
# nexus-features=\
# nexus-core-feature,\
# nexus-cma-feature
#
# Also see: https://github.com/vjda/nexus3-casc-cli
- name: Nexus install
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: True
  tasks:
    - name: Nexus role
      include_role:
        name: ansible-thoteam.nexus3-oss
        apply:
          tags:
           - nexus

- name: Nexus Post-install
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: true
  # run roles for Nexus install
  tasks:
    - name: Nexus conan role
      include_role:
        name: ska_collections.nexus.nexus-conan

    - name: HAProxy role
      include_role:
        name: ska_collections.nexus.haproxy
