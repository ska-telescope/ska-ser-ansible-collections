---
- name: Create Nginx configuration directory
  ansible.builtin.file:
    path: "{{ reverseproxy_nginx_config_dir }}"
    state: directory
    mode: 0644

- name: Get /etc/nginx/dhparam
  ansible.builtin.get_url:
    url: 'https://ssl-config.mozilla.org/ffdhe2048.txt'
    dest: "{{ reverseproxy_nginx_config_dir }}/dhparam"
    mode: 0440
    force: true

- name: Create Nginx config
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ reverseproxy_nginx_config_dir }}/nginx.conf"
    mode: 0644
  register: nginxconfig

- name: "Docker pull image for {{ reverseproxy_nginx_image }}"
  community.general.docker_image:
    source: pull
    name: "{{ reverseproxy_nginx_image }}"

- name: Remove oauth2proxy container
  community.general.docker_container:
    name: "{{ reverseproxy_oauth2proxy_name }}"
    state: absent
    stop_timeout: 60
    timeout: 120
    force_kill: false
  when: not reverseproxy_oauth2proxy_enabled

- name: "Check if {{ reverseproxy_dns_name }}-ca.crt exists"
  ansible.builtin.file:
    path: "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}-ca.crt"
    state: file

- name: "Check if {{ reverseproxy_dns_name }}.crt exists"
  ansible.builtin.file:
    path: "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}.crt"
    state: file

- name: "Check if {{ reverseproxy_dns_name }}.key exists"
  ansible.builtin.file:
    path: "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}.key"
    state: file

- name: Run Nginx reverse proxy # noqa no-handler
  community.general.docker_container:
    name: "{{ reverseproxy_nginx_name }}"
    image: "{{ reverseproxy_nginx_image }}"
    recreate: true
    restart_policy: always
    state: started
    privileged: true
    network_mode: host
    exposed_ports: "{{ reverseproxy_nginx_exposed_ports }}"
    labels: "{{ reverseproxy_labels }}"
    log_driver: "{{ reverseproxy_nginx_log_driver }}"
    log_options: "{{ reverseproxy_nginx_log_options }}"
    volumes:
      - "{{ reverseproxy_nginx_config_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}-ca.crt:/etc/nginx/{{ reverseproxy_dns_name }}-ca.crt:ro"
      - "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}.crt:/etc/nginx/{{ reverseproxy_dns_name }}.crt:ro"
      - "{{ reverseproxy_nginx_config_dir }}/{{ reverseproxy_dns_name }}.key:/etc/nginx/{{ reverseproxy_dns_name }}.key:ro"
      - "{{ reverseproxy_nginx_config_dir }}/dhparam:/etc/nginx/dhparam:ro"
