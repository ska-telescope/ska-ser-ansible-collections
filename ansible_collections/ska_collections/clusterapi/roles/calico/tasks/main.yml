---
- name: Add Calico helm repo
  kubernetes.core.helm_repository:
    name: projectcalico
    repo_url: "https://docs.tigera.io/calico/charts"

- name: Stop old Calico is running on kube-system
  kubernetes.core.k8s:
    api_version: apps/v1
    kind: DaemonSet
    name: calico-node
    namespace: kube-system
    state: absent

- name: Deploy calico chart with values
  block:
    - name: Template calico values yaml
      ansible.builtin.template:
        src: values.yaml.j2
        dest: "/tmp/calico.values.yaml"
        mode: "0644"
    - name: Deploy calico chart with values
      kubernetes.core.helm:
        name: calico
        chart_ref: "projectcalico/tigera-operator"
        chart_version: "{{ calico_version }}"
        release_namespace: "{{ calico_operator_namespace }}"
        create_namespace: true
        values_files:
          - "/tmp/calico.values.yaml"
  always:
    - name: Remove values
      ansible.builtin.file:
        path: "/tmp/calico.values.yaml"
        state: absent

# - name: Wait for Deployment to be up and running
#   kubernetes.core.k8s:
#     state: present
#     definition:
#       kind: Deployment
#       name: "{{ deployment_name }}"
#       namespace: default
#     wait_condition:
#       type: Ready
#       status: "True"
#       timeout: 300
#       delay: 10
