---
- name: Add Calico helm repo
  kubernetes.core.helm_repository:
    name: projectcalico
    repo_url: "https://docs.tigera.io/calico/charts"

- name: Stop old Calico is running on kube-system
  kubernetes.core.k8s:
    api_version: apps/v1
    kind: DaemonSet
    name: calico-node
    namespace: kube-system
    state: absent

- name: Deploy calico chart with values
  kubernetes.core.helm:
    name: calico
    chart_ref: "projectcalico/tigera-operator"
    chart_version: "{{ calico_version }}"
    release_namespace: "{{ calico_operator_namespace }}"
    create_namespace: true
    wait: true
    values:
      installation:
        enabled: true
        calicoNetwork:
          ipPools:
            - cidr: "{{ calico_ipv4pool_cidr }}"
              encapsulation: None
          nodeAddressAutodetectionV4:
            interface: "{{ calico_ip_autodetection_interface }}"
      tigeraOperator:
        version: v{{ calico_tigera_operator_version }}
      calicoctl:
        tag: v{{ calico_version }}

- name: Check kubernetes resources
  kubernetes.core.k8s_info:
    kind: "{{ item.kind }}"
    wait: true
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
    wait_sleep: 10
    wait_timeout: 600
  loop:
    - kind: Deployment
      namespace: calico-operator
      name: tigera-operator
    - kind: DaemonSet
      namespace: calico-system
      name: calico-node
    - kind: DaemonSet
      namespace: calico-system
      name: csi-node-driver
    - kind: Deployment
      namespace: calico-system
      name: calico-kube-controllers
    - kind: Deployment
      namespace: calico-apiserver
      name: calico-apiserver
    - kind: Deployment
      namespace: calico-system
      name: calico-typha
  when: calico_install_wait
