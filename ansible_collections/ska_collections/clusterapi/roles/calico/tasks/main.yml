---

- name: Download Calico manifests
  ansible.builtin.get_url:
    url: "https://raw.githubusercontent.com/projectcalico/calico/v{{ calico_version }}/manifests/calico.yaml"
    dest: "/tmp/calico.yaml"
    mode: '0664'

- name: Apply Calico manifests
  kubernetes.core.k8s:
    state: present
    apply: true
    src: "/tmp/calico.yaml"

- name: Set Calico config
  ansible.builtin.command: |
    kubectl -n kube-system set env daemonset/calico-node \
    CALICO_IPV4POOL_CIDR="{{ calico_ipv4pool_cidr }}" \
    CALICO_IPV4POOL_IPIP="{{ calico_ipv4pool_ipip }}" \
    IP_AUTODETECTION_METHOD="{{ calico_ip_autodetection_method }}"
  changed_when: false

- name: Check calico-node Daemonset is running
  ska_collections.clusterapi.wait_for_daemonset:
    name: speaker
    kubectl_namespace: metallb-system
    initpause: 10
    wait: 20
    retries: 15
    kubectl_kubeconfig: /etc/kubernetes/admin.conf

- name: Flush those handlers
  ansible.builtin.meta: flush_handlers
