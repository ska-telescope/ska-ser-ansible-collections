---

- name: Load containerd kernel drivers
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  with_items:
    - br_netfilter
    - overlay

- name: Add containerd kernel drivers to startup
  ansible.builtin.lineinfile:
    line: "{{ item }}"
    dest: /etc/modules-load.d/containerd.conf
    create: true
    owner: root
    group: root
    mode: 0644
  with_items:
    - overlay
    - br_netfilter

- name: Add containerd cri sysctl vars
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-kubernetes-cri.conf
  with_dict: "{{ capi_containerd_sysctls | combine(capi_containerd_sysctls_override) }}"

- name: Debian containerd install
  when: ansible_os_family == "Debian"
  block:
    - name: Install packages required for containerd
      ansible.builtin.apt:
        name: "{{ containerd_deb_dependencies }}"
        state: present

    - name: Add dockerproject apt key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88
        state: present

    - name: Add dockerproject apt source
      ansible.builtin.lineinfile:
        line: "deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        dest: /etc/apt/sources.list.d/docker.list
        create: true
        owner: root
        group: root
        mode: 0644

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install containerd.io
      ansible.builtin.apt:
        name: "containerd.io={{ capi_containerd_version }}"
        force: true
        state: present
      notify:
        - Restart containerd
        - Restart docker

    - name: Pin containerd version
      ansible.builtin.dpkg_selections:
        name: "containerd.io"
        selection: hold

- name: Proxy environment
  when: proxy_env is defined
  block:
    - name: Create containerd unit file drop-in folder
      ansible.builtin.file:
        path: /etc/systemd/system/containerd.service.d
        state: directory
        mode: "0755"
    - name: Add proxy env vars to systemd drop-in
      ansible.builtin.template:
        src: proxy.conf.j2
        dest: /etc/systemd/system/containerd.service.d/proxy.conf
        mode: "0644"
      notify:
        - Restart containerd

- name: Configure containerd server - arm64
  ansible.builtin.template:
    src: containerd-config.toml-arm64.j2
    dest: "/etc/containerd/config.toml"
    mode: "0644"
  notify:
    - Restart containerd
    - Restart docker
  when: ansible_architecture == 'aarch64'

- name: Configure containerd server - amd64
  ansible.builtin.template:
    src: containerd-config.toml.j2
    dest: "/etc/containerd/config.toml"
    mode: "0644"
  notify:
    - Restart containerd
    - Restart docker
  when: ansible_architecture == 'x86_64'

- name: Check if crictl exists
  ansible.builtin.stat:
    path: /usr/local/bin/crictl
  register: stat_crictl

- name: Check if the crictl version
  ansible.builtin.command: /usr/local/bin/crictl --version
  changed_when: false
  register: crictl_version_check
  ignore_errors: true

- name: Crictl install
  when: "not stat_crictl.stat.exists or
    crictl_version_check.stdout.find(crictl_version) == -1"
  block:
    - name: Set crictl_archive fact
      ansible.builtin.set_fact:
        crictl_archive: "crictl-{{ crictl_version }}-linux-{{ debian_arch }}.tar.gz"

    - name: Download crictl
      ansible.builtin.get_url:
        url: "https://github.com/kubernetes-sigs/cri-tools/releases/download/{{ crictl_version }}/{{ crictl_archive }}"
        dest: "/tmp/{{ crictl_archive }}"
        mode: "0755"
        tmp_dest: "/tmp/"

    - name: Unpack crictl
      ansible.builtin.unarchive:
        src: "/tmp/{{ crictl_archive }}"
        remote_src: true
        dest: /usr/local/bin
        mode: "0755"

    - name: Tidy up crictl download
      ansible.builtin.file:
        path: "/tmp/{{ crictl_archive }}"
        state: absent

- name: Configure crictl for containerd
  ansible.builtin.template:
    src: crictl.yaml.j2
    dest: "/etc/crictl.yaml"
    mode: "0644"

- name: Add cron job for crictl system prune
  ansible.builtin.lineinfile:
    path: /etc/crontab
    regexp: 'crictl rmi'
    line: >-
      45 */4     * * *   root    crictl rmi --prune
  become: true
  notify:
    - Restart cron

- name: Flush those handlers
  ansible.builtin.meta: flush_handlers
