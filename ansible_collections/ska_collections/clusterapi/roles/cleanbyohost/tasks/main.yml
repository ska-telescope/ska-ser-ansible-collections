---

- name: Clean out kubeadm install
  when: ansible_hostname in groups['nodes']
  block:

    - name: Force stopped byohagent
      ansible.builtin.service:
        name: byohagent.service
        state: stopped

    - name: Force stop kubelet
      ansible.builtin.service:
        name: kubelet.service
        state: stopped
      failed_when: false

    - name: Force stopped containerd
      ansible.builtin.service:
        name: containerd.service
        state: stopped
      failed_when: false

    - name: Force stopped docker
      ansible.builtin.service:
        name: docker.service
        state: stopped
      failed_when: false

    - name: Remove kube packages
      ansible.builtin.apt:
        name: ['kubeadm', 'kubelet', 'kubectl', 'docker-ce-cli', 'docker-ce']
        force: true
        purge: true
        state: absent

    - name: Reload systemctl
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Reboot host and wait for it to restart
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible"
        connect_timeout: 5
        reboot_timeout: 600
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: whoami

    - name: Remove /var/lib/kubeadm.yaml
      ansible.builtin.file:
        path: "/var/lib/kubeadm.yaml"
        state: absent

    - name: Remove /var/lib/kubelet
      ansible.builtin.file:
        path: "/var/lib/kubelet"
        state: absent

    # don't remove as it caches ?
    - name: Remove /var/lib/containerd
      ansible.builtin.file:
        path: "/var/lib/containerd"
        state: absent

    - name: Remove /etc/kubernetes
      ansible.builtin.file:
        path: "/etc/kubernetes"
        state: absent

    - name: Remove /etc/docker
      ansible.builtin.file:
        path: "/etc/docker"
        state: absent

    - name: Remove /etc/containerd
      ansible.builtin.file:
        path: "/etc/containerd"
        state: absent

    - name: Recreate empty /etc/containerd
      ansible.builtin.file:
        path: "/etc/containerd"
        state: directory
        mode: "0755"

    - name: Remove /etc/cni
      ansible.builtin.file:
        path: "/etc/cni"
        state: absent

    - name: Remove /opt/cni
      ansible.builtin.file:
        path: "/opt/cni"
        state: absent

    - name: Remove /var/lib/cni
      ansible.builtin.file:
        path: "/var/lib/cni"
        state: absent

    - name: Remove /var/lib/calico
      ansible.builtin.file:
        path: "/var/lib/calico"
        state: absent

    - name: Remove /var/lib/etcd
      ansible.builtin.file:
        path: "/var/lib/etcd"
        state: absent

    - name: Remove /etc/systemd/system/kubelet.service.d
      ansible.builtin.file:
        path: "/etc/systemd/system/kubelet.service.d"
        state: absent

    - name: Remove /etc/systemd/system/docker.service.d
      ansible.builtin.file:
        path: "/etc/systemd/system/docker.service.d"
        state: absent

    - name: Remove /etc/systemd/system/containerd.service.d
      ansible.builtin.file:
        path: "/etc/systemd/system/containerd.service.d"
        state: absent

- name: Flush those handlers
  ansible.builtin.meta: flush_handlers
