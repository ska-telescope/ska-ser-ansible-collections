---

- name: "Check ceph.conf exists {{ capi_ceph_conf_ini_file }}"
  ansible.builtin.stat:
    path: "{{ capi_ceph_conf_ini_file }}"
  register: check_ceph_conf
  delegate_to: localhost

- name: Abort playbook on missing ceph.conf
  ansible.builtin.fail:
    msg: >
      "Could not find ceph.conf file: {{ capi_ceph_conf_ini_file }}"
  when: not check_ceph_conf.stat.exists and not (capo_ceph_conf_global_fsid | default(''))

- name: "Check ceph.conf exists {{ capi_ceph_conf_key_ring }}"
  ansible.builtin.stat:
    path: "{{ capi_ceph_conf_key_ring }}"
  register: check_ceph_key_ring
  delegate_to: localhost

- name: Abort playbook on missing ceph key ring file
  ansible.builtin.fail:
    msg: >
      "Could not find ceph key ring file: {{ capi_ceph_conf_key_ring }}"
  when: not check_ceph_key_ring.stat.exists and not (capi_ceph_external_admin_secret | default(''))

- name: Get Ceph conf global section
  ansible.builtin.set_fact:
    capo_ceph_conf_global_fsid: "{% if (capo_ceph_conf_global_fsid | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'fsid', section='global', file=capi_ceph_conf_ini_file) }}{% else %}{{ capo_ceph_conf_global_fsid }}{% endif %}"  # noqa: yaml
    capo_ceph_conf_global_mon_host: "{% if (capo_ceph_conf_global_mon_host | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'mon_host', section='global', file=capi_ceph_conf_ini_file) | ska_collections.clusterapi.cephmons }}{% else %}{{ capo_ceph_conf_global_mon_host }}{% endif %}"  # noqa: yaml
    capo_ceph_conf_global_mons_data: "{% if (capo_ceph_conf_global_mons_data | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'mon_host', section='global', file=capi_ceph_conf_ini_file) | ska_collections.clusterapi.cephmonsdata }}{% else %}{{ capo_ceph_conf_global_mons_data }}{% endif %}"  # noqa: yaml
    capo_ceph_conf_global_monitors: "{% if (capo_ceph_conf_global_monitors | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'mon_host', section='global', file=capi_ceph_conf_ini_file) | ska_collections.clusterapi.cephmonitors }}{% else %}{{ capo_ceph_conf_global_monitors }}{% endif %}"  # noqa: yaml
    capo_ceph_key: "{% if (capo_ceph_key | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capo_ceph_key }}{% endif %}"  # noqa: yaml
    capi_ceph_external_admin_secret: "{% if (capi_ceph_external_admin_secret | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_external_admin_secret }}{% endif %}"  # noqa: yaml
    capi_ceph_external_admin_key: "{% if (capi_ceph_external_admin_key | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_external_admin_key }}{% endif %}"  # noqa: yaml
    capi_ceph_csi_rbd_node_secret: "{% if (capi_ceph_csi_rbd_node_secret | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_csi_rbd_node_secret }}{% endif %}"  # noqa: yaml
    capi_ceph_csi_rbd_provisioner_secret: "{% if (capi_ceph_csi_rbd_provisioner_secret | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_csi_rbd_provisioner_secret }}{% endif %}"  # noqa: yaml
    capi_ceph_csi_cephfs_node_secret: "{% if (capi_ceph_csi_cephfs_node_secret | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_csi_cephfs_node_secret }}{% endif %}"  # noqa: yaml
    capi_ceph_csi_cephfs_provisioner_secret: "{% if (capi_ceph_csi_cephfs_provisioner_secret | default('')) | length == 0 %}{{ lookup('ansible.builtin.ini', 'key', section='client.admin', file=capi_ceph_conf_key_ring) }}{% else %}{{ capi_ceph_csi_cephfs_provisioner_secret }}{% endif %}"  # noqa: yaml

- name: "Show capi_ceph_external_admin_secret"
  ansible.builtin.debug:
    var: capi_ceph_external_admin_secret

- name: "Show capo_ceph_conf_global_mon_host"
  ansible.builtin.debug:
    var: capo_ceph_conf_global_mon_host

- name: "Show capo_ceph_conf_global_mons_data"
  ansible.builtin.debug:
    var: capo_ceph_conf_global_mons_data

- name: "Show capo_ceph_conf_global_monitors"
  ansible.builtin.debug:
    var: capo_ceph_conf_global_monitors

- name: "Show capo_ceph_key"
  ansible.builtin.debug:
    var: capo_ceph_key

- name: "Show capo_ceph_conf_global_fsid"
  ansible.builtin.debug:
    var: capo_ceph_conf_global_fsid
