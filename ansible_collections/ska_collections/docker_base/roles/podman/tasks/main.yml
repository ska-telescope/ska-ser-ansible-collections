---
- name: OS Family
  ansible.builtin.debug:
    var: ansible_os_family

- name: Debian Podman install
  when: ansible_os_family == "Debian"
  block:

    - name: Remove old podman project apt source
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/podman.list
        state: absent

    - name: Ensure that the apt cache is updated
      ansible.builtin.apt:
        update_cache: true
        update_cache_retries: 30
        update_cache_retry_max_delay: 30

    - name: Set kernel.unprivileged_userns_clone=1
      ansible.posix.sysctl:
        name: kernel.unprivileged_userns_clone
        value: 1
        state: present
        ignoreerrors: true
      notify:
        - Restart procps

    - name: Set user.max_inotify_instances to 1048576
      ansible.posix.sysctl:
        name: user.max_inotify_instances
        value: 1048576
        state: present
        ignoreerrors: true

    - name: Set fs.inotify.max_user_watches to 1048576
      ansible.posix.sysctl:
        name: fs.inotify.max_user_watches
        value: 1048576
        state: present
        ignoreerrors: true

    - name: Enable Kubic apt repository
      block:
        - name: Get the gpg key
          ansible.builtin.get_url:
            url: "https://download.opensuse.org/repositories/devel:kubic:libcontainers:unstable/xUbuntu_{{ podman_ubuntu_release }}/Release.key"
            dest: /tmp/Release.key

        - name: Dearmor the gpg key
          ansible.builtin.shell: >
            cat /tmp/Release.key |
            gpg --dearmor |
            sudo tee /etc/apt/keyrings/devel_kubic_libcontainers_unstable.gpg >/dev/null

        - name: Add Kubic apt repository
          ansible.builtin.apt_repository:
            repo: >
              deb [arch={{ podman_ubuntu_arch }}
              signed-by=/etc/apt/keyrings/devel_kubic_libcontainers_unstable.gpg]
              https://download.opensuse.org/repositories/devel:kubic:libcontainers:unstable/xUbuntu_{{ podman_ubuntu_release }}/ /
            filename: devel:kubic:libcontainers:unstable
            state: present
      when: podman_version == 4

    - name: Install podman CE
      block:
        - name: Install podman CE (apt)
          ansible.builtin.apt:
            name: "{{ podman_deb_pkgs }}"
            state: present
            force: true
            update_cache: true

      rescue:
        - name: Purge podman packages
          become: true
          ansible.builtin.shell: |
            dpkg -P podman buildah skopeo crun
          args:
            executable: /bin/bash
          changed_when: false

        - name: Install podman CE (apt)
          ansible.builtin.apt:
            name: "{{ podman_deb_pkgs }}"
            state: present
            force: true
            update_cache: true

    - name: Disable Kubic apt repository
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      when: podman_version == 4
      with_items:
        - /etc/apt/keyrings/devel_kubic_libcontainers_unstable.gpg
        - /etc/apt/sources.list.d/devel:kubic:libcontainers:unstable.list

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
      when: podman_version == 4

    - name: Configure podman
      ansible.builtin.template:
        src: registries.conf.j2
        dest: "/etc/containers/registries.conf.d/mirror.conf"
        mode: 0644

    - name: Check if /etc/containers/storage.conf exists
      ansible.builtin.stat:
        path: "/etc/containers/storage.conf"
      register: result_storage

    - name: Remove metacopy=on - not supported prior 4.19
      ansible.builtin.replace:
        dest: /etc/containers/storage.conf
        regexp: '^mountopt = .*'
        replace: 'mountopt = "nodev"'
        backup: true
      when: result_storage.stat.exists

    - name: Enable service docker and ensure it is not masked
      ansible.builtin.systemd:
        name: docker
        enabled: true
        masked: false

- name: Flush those handlers
  ansible.builtin.meta: flush_handlers
