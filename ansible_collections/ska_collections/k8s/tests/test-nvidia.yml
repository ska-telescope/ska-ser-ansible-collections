- name: Test Nvidia Plugin Deployment
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
    k8s_nvidia_plugin_namespace: kube-system
    k8s_nvidia_plugin_pod_label_filter: app.kubernetes.io/name=nvidia-device-plugin
    k8s_nvidia_test_pod_namespace: default
    k8s_nvidia_test_pod_name: nvidia-test-pod
  environment:
    KUBECONFIG: "{{ k8s_kubeconfig | default(lookup('ansible.builtin.env', 'KUBECONFIG', default='/etc/kubernetes/admin.conf')) }}"
  tasks:
    - name: Get Nvidia device plugin
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ k8s_nvidia_plugin_namespace }}"
        field_selectors:
          - status.phase=Running
        label_selectors:
          - "{{ k8s_nvidia_plugin_pod_label_filter }}"
        wait: true
      register: nvidia_plugin_pods
      failed_when: (nvidia_plugin_pods.resources) | length == 0

    - name: Check Nvidia device plugin is running
      ansible.builtin.debug:
        msg: "{{ nvidia_plugin_pods.resources[0].metadata.name }} is running"

    - name: Create Nvidia test pod requesting GPU resources
      kubernetes.core.k8s:
        state: present
        template: 'resources/nvidia.yml'
        wait: true
        wait_timeout: 60

    - name: Clean up Nvidia GPU test pod
      kubernetes.core.k8s:
        state: absent
        template: 'resources/nvidia.yml'
  tags:
    - nvidia
