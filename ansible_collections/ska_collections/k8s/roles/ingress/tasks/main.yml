---

- name: Install Nginx Helm chart
  kubernetes.core.helm:
    atomic: true
    chart_repo_url: https://kubernetes.github.io/ingress-nginx
    chart_ref: ingress-nginx
    chart_version: "{{ k8s_ingress_nginx_chart_version }}"
    create_namespace: true
    namespace: ingress-nginx
    name: ingress-nginx
    values:
      controller:
        # set the name so that the svc and Octavia inherits
        # a unique one
        name: "ingress-nginx-controller-{{ k8s_ingress_lb_suffix }}"
        ingressClassResource:
          default: true
        extraArgs:
          ingress-class: nginx
        service:
          loadBalancerIP: "{{ k8s_ingress_lb_ip }}"
          annotations:
            service.beta.kubernetes.io/openstack-internal-load-balancer: "true"
          type: LoadBalancer
          nodePorts:
            http: 30080
            https: 30443

- name: Wait till the nginx is created
  kubernetes.core.k8s_info:
    kind: Deployment
    wait: true
    name: ingress-nginx-controller
    namespace: ingress-nginx
    wait_timeout: 120
