---
- name: Check if "Cluster is active" is enabled.
  ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf version
  changed_when: false
  register: kubectl_version
  ignore_errors: true
  delegate_to: "{{ groups['kubernetes-controlplane'][0] }}"
  delegate_facts: true
  when: inventory_hostname == groups['kubernetes-controlplane'][0]

- name: "Show kubectl_version"
  ansible.builtin.debug:
    var: kubectl_version
  when: debug|bool

- name: Check if "kube-state-metrics is active"
  ansible.builtin.command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get deployment kube-state-metrics --namespace kube-system
  changed_when: false
  register: kubectl_metrics
  ignore_errors: true
  when: "inventory_hostname == groups['kubernetes-controlplane'][0]"

- name: Activate kube-state-metrics
  when: "inventory_hostname == groups['kubernetes-controlplane'][0]
    and kubectl_metrics.rc and k8s_state_metrics"
  tags: kube-state-metrics
  block:
    # The following two tasks can be removed once all deployments are managed by Helm
    - name: Remove legacy manifest-deployed kube-state-metrics-nodeport Service
      kubernetes.core.k8s:
        kind: Service
        name: kube-state-metrics-nodeport
        namespace: kube-system
        state: absent

    - name: Migrate manifest-deployed kube-state-metrics objects to be managed by Helm
      kubernetes.core.k8s:
        state: patched
        namespace: kube-system
        template: ksm-helmify.yaml

    - name: Install kube-state-metrics Helm chart
      kubernetes.core.helm:
        atomic: true
        chart_repo_url: https://prometheus-community.github.io/helm-charts
        chart_ref: kube-state-metrics
        chart_version: "{{ k8s_state_metrics_chart_version }}"
        name: kube-state-metrics
        namespace: kube-system
        values:
          service:
            type: NodePort
            nodePort: 32080
          selfMonitor:
            enabled: true
            telemetryNodePort: 32081
