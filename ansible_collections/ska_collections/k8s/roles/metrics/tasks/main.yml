---

- name: Check if "Cluster is active" is enabled.
  command: kubectl --kubeconfig=/etc/kubernetes/admin.conf version
  changed_when: false
  register: kubectl_version
  ignore_errors: true
  delegate_to: "{{ groups['kubernetes-controlplane'][0] }}"
  delegate_facts: true
  when: inventory_hostname == groups['kubernetes-controlplane'][0]

- name: "Show kubectl_version"
  debug: var=kubectl_version
  when: debug|bool

- name: Check if "kube-state-metrics is active"
  command: kubectl --kubeconfig=/etc/kubernetes/admin.conf get deployment kube-state-metrics --namespace kube-system
  changed_when: false
  register: kubectl_metrics
  ignore_errors: true
  when: "inventory_hostname == groups['kubernetes-controlplane'][0]"

- name: Activate kube-state-metrics
  block:
    - name: Init kube-state-metrics.
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf \
        delete -f https://raw.githubusercontent.com/kubernetes/kube-state-metrics/master/examples/standard/cluster-role-binding.yaml \
        -f https://raw.githubusercontent.com/kubernetes/kube-state-metrics/master/examples/standard/cluster-role.yaml \
        -f https://raw.githubusercontent.com/kubernetes/kube-state-metrics/master/examples/standard/deployment.yaml \
        -f https://raw.githubusercontent.com/kubernetes/kube-state-metrics/master/examples/standard/service-account.yaml \
        -f https://raw.githubusercontent.com/kubernetes/kube-state-metrics/master/examples/standard/service.yaml
      register: kube_state_metrics_result
      changed_when: kube_state_metrics_result.stdout_lines|map('split')|map(attribute="1")|unique|list != ["unchanged"]

    - name: NodePort configuration for kube-state-metrics
      blockinfile:
        path: /tmp/kube-state-metrics-nodeport.yaml
        create: true
        block: |
          ---
          apiVersion: v1
          kind: Service
          metadata:
            labels:
              app.kubernetes.io/name: kube-state-metrics-nodeport
              app.kubernetes.io/version: 1.9.5
            name: kube-state-metrics-nodeport
            namespace: kube-system
          spec:
            type: NodePort
            ports:
            - name: http-metrics
              port: 8080
              nodePort: 32080
              targetPort: http-metrics
            - name: telemetry
              port: 8081
              nodePort: 32081
              targetPort: telemetry
            selector:
              app.kubernetes.io/name: kube-state-metrics
        mode: "0644"

    - name: Init kube-state-metrics.
      command: kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f /tmp/kube-state-metrics-nodeport.yaml
      register: nodeport_output
      changed_when: nodeport_output.stdout_lines|map('split')|map(attribute="1")|unique|list != ["unchanged"]

  when: "inventory_hostname == groups['kubernetes-controlplane'][0]
    and kubectl_metrics.rc and kube_state_metrics"


    

    

