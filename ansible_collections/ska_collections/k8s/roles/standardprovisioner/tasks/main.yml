---
- name: Check KUBECONFIG
  ansible.builtin.debug:
    msg: "KUBECONFIG: {{ lookup('ansible.builtin.env', 'KUBECONFIG', default=k8s_kubeconfig) | mandatory }}"

- name: Check if KUBECONFIG is readable
  ansible.builtin.stat:
    path: "{{ lookup('ansible.builtin.env', 'KUBECONFIG', default=k8s_kubeconfig) | mandatory }}"
  register: check_kubeconfig

- name: Fail if KUBECONFIG is NOT readable
  ansible.builtin.fail:
    msg: "KUBECONFIG is NOT readable: {{ lookup('ansible.builtin.env', 'KUBECONFIG', default=k8s_kubeconfig) | mandatory }}"
  when: not check_kubeconfig.stat.exists
  any_errors_fatal: true

- name: Apply Standard Storage Provisioner (hostpath)
  kubernetes.core.k8s:
    state: present
    template: 'provisioner.yaml.j2'

- name: Wait till the storage-provisioner is created
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    name: storage-provisioner
    namespace: kube-system
    wait: yes
    wait_timeout: 120

- name: Flush those handlers
  ansible.builtin.meta: flush_handlers
