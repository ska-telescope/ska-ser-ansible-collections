- name: Check if the kubectl version is installed
  ansible.builtin.command: "kubectl version --client --short 2>&1"
  changed_when: false
  register: kubectl_version
  ignore_errors: true

- name: Ensure target directory
  ansible.builtin.file:
    path: '{{ common_server_kubectl_install_dir }}'
    state: directory
    mode: '0755'
  when: kubectl_version.rc != 0

- name: Download kubectl
  become: true
  ansible.builtin.get_url:
    url: '{{ common_server_kubectl_url }}'
    dest: '{{ common_server_kubectl_install_dir }}/{{ common_server_kubectl_name }}-{{ common_server_kubectl_version }}'
    mode: 0755
  when: kubectl_version.rc != 0

- name: Link installed kubectl # noqa ignore-errors
  become: true
  ignore_errors: true
  ansible.builtin.file:
    src: '{{ common_server_kubectl_install_dir }}/{{ common_server_kubectl_name }}-{{ common_server_kubectl_version }}'
    dest: '{{ common_server_kubectl_install_dir }}/{{ common_server_kubectl_name }}'
    state: link
    mode: 0755
  when: kubectl_version.rc != 0

- name: Create directory
  ansible.builtin.file:
    path: /etc/kubernetes/
    state: directory
    mode: 0755

- name: Copy KUBECONFIG file
  ansible.builtin.copy:
    src: "{{ common_kubeconfig }}"
    dest: "/etc/kubernetes/admin.conf"
    mode: 0755
  become: true
