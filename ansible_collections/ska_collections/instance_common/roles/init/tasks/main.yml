---
- name: Ensure that the apt cache is updated
  apt:
    update_cache: true
  register: apt_res
  retries: 30
  delay: 30
  until: apt_res is success

- name: Set hostname
  hostname:
    name: "{{ inventory_hostname }}"
  when: not inventory_hostname == "localhost" and change_hostnames
  become: true

- name: Update /etc/hosts
  lineinfile:
    dest: /etc/hosts
    regexp: '.*{{ hostvars[item].inventory_hostname }}.*'
    line: "{{ hostvars[item].ip }} {{ hostvars[item].inventory_hostname }}"
    state: present
  with_items: '{{ groups["all"] }}'
  when: not item == "localhost"
  register: updatehosts
  become: true

- name: Mount all volumes
  include_tasks: "./mount_volume.yml"
  loop: "{{ hostvars[inventory_hostname]['volumes'] }}"
  loop_control:
    loop_var: volume
  when: hostvars[inventory_hostname]['volumes'] is defined

- name: Ensure required packages are installed (apt)
  apt:
    name: "{{ common_packages|default([]) }}"
    update_cache: true
    state: present
  register: apt_res
  retries: 30
  delay: 30
  until: apt_res is success
  when: ansible_os_family == "Debian"

- name: Upgrade all packages (apt)
  apt:
    upgrade: dist
    autoremove: true
  when: ansible_os_family == "Debian"
  register: apt_res
  retries: 30
  delay: 30
  until: apt_res is success
