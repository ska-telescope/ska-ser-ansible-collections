---
- name: Ensure grafana provisioning directory
  ansible.builtin.file:
    path: '{{ prometheus_grafana_provisioning_config_dir }}/datasources'
    state: directory
    mode: 0755
    owner: "{{ prometheus_localuser }}"
    group: "{{ prometheus_localgroup }}"
  become: true


- name: Ensure grafana data directory
  ansible.builtin.file:
    path: '{{ prometheus_grafana_data }}'
    state: directory
    mode: 0755
    owner: "{{ prometheus_localuser }}"
    group: "{{ prometheus_localgroup }}"
  become: true

- name: Generate Prometheus datasource on grafana
  become: true
  ansible.builtin.template:
    src: "datasource.yaml.j2"
    dest: "{{ prometheus_grafana_provisioning_config_dir }}/datasources/datasource.yaml"
    force: true
    owner: "{{ prometheus_localuser }}"
    group: "{{ prometheus_localgroup }}"
    mode: 0755

- name: Pull grafana image {{ prometheus_grafana_docker_tags }}
  community.docker.docker_image:
    name: grafana/grafana
    tag: "{{ prometheus_grafana_docker_tags }}"
    source: pull

- name: Stop grafana container
  community.docker.docker_container:
    name: grafana
    state: absent

- name: Start grafana container
  community.docker.docker_container:
    name: grafana
    image: "grafana/grafana:{{ prometheus_grafana_docker_tags }}"
    state: started
    user: root
    restart: true
    restart_policy: always
    ports:
      - "3000:3000"
    volumes:
      - "{{ prometheus_grafana_provisioning_config_dir }}:/etc/grafana/provisioning"
      - "{{ prometheus_grafana_data }}:/var/lib/grafana"
      - "/etc/hosts:/etc/hosts:ro"
    env:
      GF_INSTALL_PLUGINS: "{{ prometheus_grafana_plugins | join(',') }}"
      GF_SECURITY_DISABLE_INITIAL_ADMIN_CREATION: "{{ prometheus_grafana_disable_admin_account_creation }}"
      GF_SECURITY_ADMIN_PASSWORD: "{{ prometheus_grafana_admin_password }}"
      GF_PANELS_DISABLE_SANITIZE_HTML: true
      GF_SERVER_ROOT_URL: "https://{{ prometheus_k8s_external_dns_entry }}/grafana"
      GF_SERVER_SERVE_FROM_SUB_PATH: true
      # AzureAD Configuration
      GF_AUTH_AZUREAD_NAME: "Azure AD"
      GF_AUTH_AZUREAD_ENABLED: true
      GF_AUTH_AZUREAD_ALLOW_SIGN_UP: true
      GF_AUTH_AZUREAD_CLIENT_ID: "{{ azuread_client_id }}"
      GF_AUTH_AZUREAD_CLIENT_SECRET: "{{ azuread_client_secret }}"
      GF_AUTH_AZUREAD_SCOPES: "openid email profile"
      GF_AUTH_AZUREAD_AUTH_URL: "https://login.microsoftonline.com/{{ azuread_tenant_id }}/oauth2/v2.0/authorize"
      GF_AUTH_AZUREAD_TOKEN_URL: "https://login.microsoftonline.com/{{ azuread_tenant_id }}/oauth2/v2.0/token"
      GF_AUTH_AZUREAD_ALLOWED_DOMAINS: ""
      GF_AUTH_AZUREAD_ALLOWED_GROUPS: ""
      GF_AUTH_AZUREAD_ROLE_ATTRIBUTE_STRICT: false