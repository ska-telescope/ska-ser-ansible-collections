---
# tasks file for prometheus
- name: Install distutils
  ansible.builtin.apt:
    pkg:
      - python3-distutils
      - python3-requests
      - jq
    state: present
    update_cache: true
  when: ansible_os_family == "Debian" and (mode == "server" or mode == "all" or mode == "docker")

- name: Fix pip
  when: mode == "server" or mode == "all" or mode == "docker"
  block:
    - name: Install packages required for docker (apt)
      ansible.builtin.apt:
        name: ['python3-pip']
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure dnf installed
      ansible.builtin.yum:
        name: "dnf"
        state: present
      when: ansible_distribution == "CentOS"

    - name: Install packages required for docker (dnf)
      ansible.builtin.dnf:
        name: ['python-pip', 'python3-pip']
        state: present
      when: ansible_os_family == "RedHat"

    - name: Uninstall docker dependencies
      ansible.builtin.pip:
        name: ['docker-py', 'docker-pycreds']
        executable: pip3
        state: absent

    - name: Install docker dependencies
      ansible.builtin.pip:
        executable: pip3
        name: docker

- name: Pip self-update  # noqa package-latest
  ansible.builtin.pip:
    name: pip
    state: latest
  when: mode == "server" or mode == "all" or mode == "docker"

- name: Install certain apt packages for openstack
  ansible.builtin.apt:
    pkg:
      - python3-heatclient
      - python3-novaclient
      - python3-keystoneauth1
    state: present
    update_cache: true
  when: ansible_os_family == "Debian" and (mode == "server" or mode == "all" or mode == "docker")
  tags:
    - openstack

- name: Install certain python modules for openstack
  ansible.builtin.pip:
    name: "{{ item.name }}"
    version: "{{ item.version }}"
    executable: pip3
    state: present
  with_items:
    - {name: openstacksdk, version: 0.43.0}
    - {name: python-openstackclient, version: 5.2.0}
    - {name: kubernetes, version: 12.0.1}
    - {name: pymysql, version: 1.0.2}
  when: mode == "server" or mode == "all" or mode == "docker"
  tags:
    - openstack

- name: Task grafana_ceph
  ansible.builtin.include_tasks: blackbox_exporter.yml
  when: mode == "server" or mode == "all"

- name: Task runner_exporter
  ansible.builtin.include_tasks: runner_exporter.yml
  when: mode == "runner"

- name: Task docker_exporter
  ansible.builtin.include_tasks: docker_exporter.yml
  when: mode == "docker"

- name: Task grafana_ceph
  ansible.builtin.include_tasks: grafana_ceph.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task grafana_elasticstack
  ansible.builtin.include_tasks: grafana_elasticstack.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task grafana_kubernetes
  ansible.builtin.include_tasks: grafana_kubernetes.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task grafana_gitlab_runners
  ansible.builtin.include_tasks: grafana_gitlab_runners.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task grafana_cadvisor
  ansible.builtin.include_tasks: grafana_cadvisor.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task grafana_nodexporter
  ansible.builtin.include_tasks: grafana_nodexporter.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

- name: Task gitlab_ci_pipelines_exporter
  ansible.builtin.include_tasks: gitlab_ci_pipelines_exporter.yml
  when: mode == "server" or mode == "all"

- name: Task grafana_alerts
  ansible.builtin.include_tasks: grafana_alerts.yml
  when: mode == "grafana" or mode == "server" or mode == "all"

# launch prom/alert/grafana after configuration
- name: Task server
  ansible.builtin.include_tasks: server.yml
  when: mode == "server" or mode == "all"
  tags:
    - cron

- name: Task thanos_sidecar
  ansible.builtin.include_tasks: thanos_sidecar.yml
  when: mode == "server" or mode == "all"
  tags:
    - cron

- name: Task thanos_query
  ansible.builtin.include_tasks: thanos_query.yml
  when: mode == "thanos" or mode == "all"
  tags:
    - cron

- name: Task thanos_query_frontend
  ansible.builtin.include_tasks: thanos_query_frontend.yml
  when: mode == "thanos" or mode == "all"
  tags:
    - cron

- name: Task thanos_store
  ansible.builtin.include_tasks: thanos_store.yml
  when: mode == "thanos" or mode == "all"
  tags:
    - cron

- name: Thanos_compactor task
  ansible.builtin.include_tasks: thanos_compactor.yml
  when: mode == "thanos" or mode == "all"
  tags:
    - cron

- name: Alert_manager task
  ansible.builtin.include_tasks: alert_manager.yml
  when: mode == "server" or mode == "all"
  tags:
    - cron

- name: Grafana task
  ansible.builtin.include_tasks: grafana.yml
  when: mode == "grafana" or mode == "server" or mode == "all"
  tags:
    - cron
