- name: Check if playbook is already running
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:

  - name: Check if lock file exists
    ansible.builtin.stat:
      path: /tmp/shutdown-playbook.lock
    ignore_errors: true
    register: lock_stat

  - name: Fail if lockfile exists
    ansible.builtin.fail:
      msg: "Another instance of this playbook is already running! Abort..."
    when: lock_stat.stat.exists == true

  - name: Create lockfile
    ansible.builtin.file:
      path: /tmp/shutdown-playbook.lock
      state: touch
    register: lockfile

  - name: "Print traps vars"
    ansible.builtin.debug:
      msg: |
        rupsEstimatedMinutesRemaining: {{ rupsEstimatedMinutesRemaining }}
        rupsSecondsOnBattery: {{ rupsSecondsOnBattery }}
        rupsConfigLowBattTime: {{ rupsConfigLowBattTime }}

  - name: Remove lockfile
    ansible.builtin.file:
      path: /tmp/shutdown-playbook.lock
      state: absent
