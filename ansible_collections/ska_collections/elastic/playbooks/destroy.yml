#!/usr/bin/env ansible-playbook
---

- name: "Remove containers"
  hosts: "{{ target_hosts }}"
  become: yes

  vars_files:
    - ../roles/stack/defaults/main.yml
    - ../roles/logging/defaults/main.yml

  vars_prompt:

    - name: ireallymeanit
      prompt: This will destroy the {{ target_hosts }} elastic cluster and its data. Confirm? [yes,no]
      private: no
      

  tasks:
    - name: "Show ireallymeanit"
      debug: var=ireallymeanit    

    - name: exit playbook, if user did not mean to tear down ElasticStack
      fail:
        msg: >
          "Exiting teardown playbook. To really do it, say 'yes' on the prompt"
      when: ireallymeanit != 'yes'

    - name: "Show stack nodes info"
      debug: var=hostvars[inventory_hostname]
      when: debug

    - name: elk remove containers
      docker_container:
        name: "{{ item }}"
        state: absent
        stop_timeout: 60
        timeout: 120
        force_kill: no
      with_items:
        - elk_elasticsearch
        - elk_kibana
        - "{{ eexporter_name }}"
        - "{{ filebeat_name }}"

    - name: "Recursively remove {{ stack_data_dir }}/elasticsearch directory"
      file:
        path: "{{ stack_data_dir }}/elasticsearch"
        state: absent
