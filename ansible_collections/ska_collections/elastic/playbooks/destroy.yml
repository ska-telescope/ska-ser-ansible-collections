#!/usr/bin/env ansible-playbook
---

- name: "Remove containers"
  hosts: "{{ target_hosts }}"
  vars:
    target_hosts: localhost
  become: yes
  vars_files:
    - ../roles/stack/defaults/main.yml
    - ../roles/logging/defaults/main.yml
  vars_prompt:
    - name: ireallymeanit
      prompt: This will destroy the {{ target_hosts }} elastic cluster and its data. Confirm? [yes,no]
      private: no
  tasks:
    - name: Show ireallymeanit
      ansible.builtin.debug: var=ireallymeanit
      when: debug
    - name: Abort playbook
      ansible.builtin.fail:
        msg: >
          "Exiting teardown playbook. To really do it, say 'yes' on the prompt"
      when: ireallymeanit != 'yes'
    - name: Show stack nodes info
      ansible.builtin.debug: var=hostvars[inventory_hostname]
      when: debug
    - name: Remove containers
      community.general.docker_container:
        name: "{{ item }}"
        state: absent
        stop_timeout: 60
        timeout: 120
        force_kill: no
      with_items:
        - "{{ elasticsearch_name }}"
        - "{{ elasticsearch_exporter_name }}"
        - "{{ kibana_name }}"
        - "{{ filebeat_name }}"
    - name: "Recursively remove {{ elasticsearch_data_dir }} directory"
      file:
        path: "{{ elasticsearch_data_dir }}"
        state: absent
