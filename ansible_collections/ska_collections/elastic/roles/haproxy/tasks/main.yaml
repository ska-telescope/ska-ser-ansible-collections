---
- name: Create HAProxy config
  ansible.builtin.template:
    src: haproxyConfig.j2
    dest: "/etc/haproxy.cfg"
    mode: 0644
  vars:
    elasticsearch_api_port: elasticsearch_api_port
    elasticsearch_health_endpoint: elasticsearch_health_endpoint
  register: haproxy_config

- name: Show HAProxy config
  ansible.builtin.debug:
    var: haproxy_config
  when: debug

- name: "Docker pull image for {{ haproxy_image }}"
  community.general.docker_image:
    source: pull
    name: "{{ haproxy_image }}"
  register: haproxy_image_pull

- name: "Get {{ haproxy_name }} container info"
  community.general.docker_container_info:
    name: "{{ haproxy_name }}"
  register: haproxy_info

- name: "Run {{ haproxy_name }} container"  # noqa no-handler
  community.general.docker_container:
    name: "{{ haproxy_name }}"
    image: "{{ haproxy_image }}"
    recreate: true
    restart_policy: always
    state: started
    privileged: true
    network_mode: host
    exposed_ports:
      - "{{ haproxy_stats_port }}"
      - "{{ haproxy_elasticsearch_port }}"
    labels: "{{ haproxy_labels }}"
    log_driver: "{{ haproxy_log_driver }}"
    log_options: "{{ haproxy_log_options }}"
    volumes:
      - /etc/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    command: -f /usr/local/etc/haproxy/haproxy.cfg
  when: haproxy_config.changed or haproxy_image_pull.changed or not haproxy_info.exists or not haproxy_info.container.State.Running
