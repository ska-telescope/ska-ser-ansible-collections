---
- name: Deploy the filebeat logger
  block:

    - name: Install crun as default runtime
      ansible.builtin.package:
        name: crun
        state: present
        
    - name: podman pull image for filebeat
      containers.podman.podman_image:
        name: "{{ filebeat_image }}"

    - name: filebeat remove containers
      containers.podman.podman_container:
        name: "{{ filebeat_name }}"
        state: absent

    - name: Write filebeat config
      template:
        src: filebeat.yaml.j2
        dest: /etc/filebeat.yaml
        mode: 0644

    - name: Write beat policy config
      template:
        src: policy.json.j2
        dest: /etc/beat_policy.json
        mode: 0644

    - name: Create certificates directory
      ansible.builtin.file:
        path: "{{ certificates_dir }}"
        state: directory
        mode: "0700"

    - name: check if key file exists
      stat:
        path: "{{ certificates_dir }}/{{ client_cert_prefix }}.key"
      register: keyfile_exists

    - name: Create private key for new certificate
      community.crypto.openssl_privatekey:
        path: "{{ certificates_dir }}/{{ client_cert_prefix }}.key"
        passphrase: "{{ ca_cert_pass }}"
        cipher: auto
      when: keyfile_exists.stat.exists == False

    - name: check if pem file exists
      stat:
        path: "{{ certificates_dir }}/{{ client_cert_prefix }}.pem"
      register: pemfile_exists

    - name: Create certificate signing request (CSR) for new certificate
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ certificates_dir }}/{{ client_cert_prefix }}.key"
        privatekey_passphrase: "{{ ca_cert_pass }}"
        common_name: "{{ ansible_hostname }}"
        subject_alt_name: "DNS:{{ ansible_fqdn }}"
        organization_name: "SKAO"
      register: csr
      changed_when: false
      when: pemfile_exists.stat.exists == False

    - name: Sign certificate with our CA
      community.crypto.x509_certificate_pipe:
        csr_content: "{{ csr.csr }}"
        provider: ownca
        ownca_path: "{{ certificates_dir }}/ca-certificate.pem"
        ownca_privatekey_path: "{{ certificates_dir }}/ca-certificate.key"
        ownca_privatekey_passphrase: "{{ ca_cert_pass }}"
        ownca_not_after: +365d # valid for one year
        ownca_not_before: "-1d" # valid since yesterday
      delegate_to: terminus
      remote_user: ubuntu
      register: certificate
      when: pemfile_exists.stat.exists == False

    - name: Write certificate file on client host
      copy:
        dest: "{{ certificates_dir }}/{{ client_cert_prefix }}.pem"
        content: "{{ certificate.certificate }}"
      when: pemfile_exists.stat.exists == False

    - name: Check if CA pem file exists
      stat:
        path: "{{ certificates_dir }}/ca-certificate.pem"
      changed_when: false
      register: capemfile_exists

    - name: Get CA certificate pem from Terminus
      ansible.builtin.slurp:
        src: "{{ certificates_dir }}/ca-certificate.pem"
      delegate_to: terminus
      remote_user: ubuntu
      register: capemfile
      changed_when: false
      run_once: true
      when: capemfile_exists.stat.exists == False

    - name: Write CA certificate file on client host
      copy:
        content: "{{ capemfile['content'] | b64decode }}"
        dest: "{{ certificates_dir }}/ca-certificate.pem"
      when: capemfile_exists.stat.exists == False

    - name: scope for update pipeline
      block:
        - name: Write ska_log_parsing_pipeline config
          template:
            src: ska_log_parsing_pipeline.json.j2
            dest: /etc/ska_log_parsing_pipeline.json
            mode: 0644
          register: ska_log_parsing_pipeline_conf

        - name: Slurp /etc/ska_log_parsing_pipeline.json file
          slurp:
            src: /etc/ska_log_parsing_pipeline.json
          register: ska_log_parsing_pipeline_file

        # curl -XPUT --retry-connrefused --connect-timeout 5 --retry 999 \
        #  --retry-delay 1 "http://$${ip}:9200"/_ingest/pipeline/ska_log_parsing_pipeline \
        #  -H "kbn-xsrf: true" -H "Content-Type: application/json" -d @./tools/ska_log_parsing_pipeline.json;
        - name: update pipeline config
          uri:
            url: "{{ logging_elasticsearch_addresses[0] }}/_ingest/pipeline/{{ filebeat_pipeline }}"
            method: PUT
            return_content: true
            body: "{{ ska_log_parsing_pipeline_file['content'] | b64decode }}"
            status_code: 200
            body_format: json
          when: ska_log_parsing_pipeline_conf.changed

      when: "filebeat_pipeline and 'elkmasters' in groups and inventory_hostname == groups['elkmasters'][0]"

    - name: scope for index initialisation
      block:
        - name: Write filebeat config
          template:
            src: filebeat.yaml.j2
            dest: /etc/filebeat_setup.yaml
            mode: 0644
          register: filebeat_conf
      vars:
        filebeat_template_overwrite: true
      when: "'elkmasters' in groups and inventory_hostname == groups['elkmasters'][0]"

    # # should not need this
    # # setup filebeat
    # - name: Setup filebeat
    #   containers.podman.podman_container:
    #     name: "{{ filebeat_name }}_setup"
    #     image: "{{ filebeat_image }}"
    #     command: >
    #       filebeat setup -e "output.elasticsearch.hosts=['http://{{ ansible_default_ipv4.address }}:9200']"
    #        -e -strict.perms=false -e setup.ilm.enabled=auto -c /etc/filebeat_setup.yaml
    #     # annotation:
    #     #   run.oci.keep_original_groups: 1
    #     restart_policy: "no"
    #     state: started
    #     recreate: true
    #     detach: false
    #     rm: true
    #     user: root
    #     memory: "512M"
    #     labels: "{{ container_labels }}"
    #     log_driver: "{{ log_driver }}"
    #     log_options: "{{ log_options }}"
    #     volumes:
    #       - "/var/log:/var/log:ro"  # symlinks to pod logs and container logs
    #       - "/var/run/docker.sock:/var/run/docker.sock:Z"
    #       - "/var/lib/kubelet/pods:/var/lib/kubelet/pods:ro"  # kubelet logs
    #       - "/var/lib/docker/containers:/var/lib/docker/containers:ro"  # docker logs
    #       - "/var/lib/filebeat:/usr/share/filebeat/data/registry/filebeat:rw"  # persistent registry
    #       - "/etc/hostname:/etc/hostname:ro"
    #       - "/etc/machine-id:/etc/machine-id:ro"
    #       - "/etc/filebeat_setup.yaml:/etc/filebeat_setup.yaml:ro"
    #       - "/etc/beat_policy.json:/etc/beat_policy.json:ro"
    #       - "{{ kubeconf_file }}:/kube_config:ro"
    #   when: filebeat_conf.changed and 'elkmasters' in groups and inventory_hostname == groups['elkmasters'][0]

    - name: Creates directory for /var/lib/filebeat
      file:
        path: "/var/lib/filebeat"
        state: directory
        owner: root
        group: root
        mode: "0755"

    # make sure that the store version file exists
    - name: check if meta.json file exists
      stat:
        path: /var/lib/filebeat/meta.json
      register: meta_json

    - name: Set version file for filebeat
      lineinfile:
        line: '{"version": "1"}'
        dest: /var/lib/filebeat/meta.json
        create: true
        owner: root
        group: root
        mode: 0644
      when: not meta_json.stat.exists

    # deploy filebeat for ES logging
    - name: Deploy ElasticStack filebeat with K8s
      containers.podman.podman_container:
        name: "{{ filebeat_name }}"
        image: "{{ filebeat_image }}"
        command: "filebeat -e -strict.perms=false -c /etc/filebeat.yaml"
        # annotation:
        #   run.oci.keep_original_groups: 1
        # privileged: true
        restart_policy: always
        network_mode: host
        user: root
        memory: "512M"
        # memory_swap: "1G" # can't use as swap is disabled by default
        labels: "{{ container_labels }}"
        log_driver: "{{ log_driver }}"
        log_options: "{{ log_options }}"
        volumes:
          - "/var/log:/var/log:ro"  # symlinks to pod logs and container logs
          - "/var/run/docker.sock:/var/run/docker.sock:Z"
          - "/var/lib/docker/containers:/var/lib/docker/containers:ro"  # docker logs
          - "/var/lib/kubelet/pods:/var/lib/kubelet/pods:ro"  # kubernetes containers
          - "/var/lib/filebeat:/usr/share/filebeat/data/registry/filebeat:rw"  # persistent registry
          - "/etc/hostname:/etc/hostname:ro"
          - "/etc/machine-id:/etc/machine-id:ro"
          - "/etc/filebeat.yaml:/etc/filebeat.yaml:ro"
          - "/etc/beat_policy.json:/etc/beat_policy.json:ro"
          - "{{ kubeconf_file }}:/kube_config:ro"
          - "/var/log/journal:/var/log/journal:ro"  # journal databases
          - "/run/systemd:/run/systemd:ro"
          - "/etc/pki/:/etc/pki/"
      when: log_kubernetes

    # deploy filebeat for ES logging
    - name: Deploy ElasticStack filebeat without K8s
      containers.podman.podman_container:
        name: "{{ filebeat_name }}"
        image: "{{ filebeat_image }}"
        command: "filebeat -e -strict.perms=false -c /etc/filebeat.yaml"
        # annotation:
        #   run.oci.keep_original_groups: 1
        # privileged: true
        restart_policy: always
        network_mode: host
        user: root
        memory: "512M"
        # memory_swap: "1G" # can't use as swap is disabled by default
        labels: "{{ container_labels }}"
        log_driver: "{{ log_driver }}"
        log_options: "{{ log_options }}"
        volumes:
          - "/var/log:/var/log:ro"  # symlinks to pod logs and container logs
          - "/var/run/docker.sock:/var/run/docker.sock:Z"
          - "/var/lib/docker/containers:/var/lib/docker/containers:ro"  # docker logs
          # - "/var/lib/kubelet/pods:/var/lib/kubelet/pods:ro"  # kubernetes containers
          - "/var/lib/filebeat:/usr/share/filebeat/data/registry/filebeat:rw"  # persistent registry
          - "/etc/hostname:/etc/hostname:ro"
          - "/etc/machine-id:/etc/machine-id:ro"
          - "/etc/filebeat.yaml:/etc/filebeat.yaml:ro"
          - "/etc/beat_policy.json:/etc/beat_policy.json:ro"
          - "/var/log/journal:/var/log/journal:ro"  # journal databases
          - "/run/systemd:/run/systemd:ro"
          - "/etc/pki/:/etc/pki/"
      when: not log_kubernetes
  tags:
    - filebeat
