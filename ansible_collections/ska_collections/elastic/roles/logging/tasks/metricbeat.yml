---
- name: download https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-5.4.0-amd64.deb
  get_url:
    url: https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-5.4.0-amd64.deb
    dest: /var/tmp/metricbeat-5.4.0-amd64.deb

- name: Install /var/tmp/metricbeat-5.4.0-amd64.deb package
  apt:
    deb: /var/tmp/metricbeat-5.4.0-amd64.deb
  register: updatemetricbeat

# curl -G --data-urlencode 'match[]={job=~".+"}' http://10.111.1.11:9090/federate
# GET /federate?match[]=%7Bjob%3D~%22.%2B%22%7D HTTP/1.1
- name: /etc/metricbeat/metricbeat.yml
  copy:
    content: |-
      metricbeat.modules:
      - module: docker
        # metricsets: ["container", "cpu", "diskio", "healthcheck", "info", "memory", "network"]
        metricsets: ["container", "cpu", "diskio", "info", "memory", "network"]
        hosts: ["unix:///var/run/docker.sock"]
        enabled: true
        period: 10s

      - module: system
        metricsets:
          # CPU stats
          - cpu

          # System Load stats
          - load

          # Per CPU core stats
          - core

          # IO stats
          - diskio

          # Per filesystem stats
          - filesystem

          # File system summary stats
          - fsstat

          # Memory stats
          - memory

          # Network stats
          - network

          # Per process stats
          - process

          # Sockets (linux only)
          #- socket
        enabled: true
        period: 10s
        processes: ['.*']

      output.logstash:
        # The Logstash hosts
        hosts: ["logstash1:5044"]
        index: metrics

      logging.level: info

      logging.selectors: ["*"]

    force: true
    dest: /etc/metricbeat/metricbeat.yml
    mode: 0644
  register: updatemetricbeat

- name: ensure metricbeat restarts  # noqa no-handler
  service: name=metricbeat state=restarted enabled=true
  when: updatemetricbeat.changed
  become: true
