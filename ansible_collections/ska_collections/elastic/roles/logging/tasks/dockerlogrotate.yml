---
- name: Deploy log rotation
  block:
    - name: Check that the daemon.json exists
      ansible.builtin.stat:
        path: /etc/docker/daemon.json
      register: stat_result

    - name: Create daemon.json file
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        mode: 0644
        content: |
          {
            "metrics-addr" : "0.0.0.0:9323",
            "experimental" : true,
              "log-driver": "{{ log_driver }}",
              "log-opts": {
                "max-size": "{{ log_max_size }}",
                "max-file": "{{ log_max_file }}"
              }
          }
      when: not stat_result.stat.exists

    - name: Load daemon.json from file
      ansible.builtin.slurp:
        src: /etc/docker/daemon.json
      register: daemon

    - name: Load daemon.json
      set_fact:
        daemon: "{{ daemon.content | b64decode | from_json }}"

    - name: Debug loaded daemon
      debug:
        var: daemon
      when: debug|bool

    - name: Configure log-driver
      set_fact:
        daemon: "{{ daemon | default([]) | combine({ 'log-driver': log_driver }) }}"
      when: daemon['log-driver'] is not defined

    - name: Configure log-opts
      set_fact:
        daemon: "{{ daemon | default([]) | combine({ 'log-opts': log_options }) }}"
      when: daemon['log-opts'] is not defined

    - name: Configure metrics
      set_fact:
        daemon: "{{ daemon | default([]) | combine({ 'metrics-addr' : '0.0.0.0:9323', 'experimental' : true}) }}"
      when: daemon['metrics-addr'] is not defined

    - name: Debug daemon
      debug:
        var: daemon
      when: debug|bool

    - name: Remove journald entry
      ansible.builtin.lineinfile:
        line: "OPTIONS='--selinux-enabled --signature-verification=false'"
        regexp: '^OPTIONS='
        dest: /etc/sysconfig/docker
      when: ansible_os_family == "RedHat"
      ignore_errors: true
      notify: restart docker

    - name: Remove journald reference
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/docker.service.d/docker.conf
        regexp: '^(.*)--log-driver=journald(.*)$'
        line: '\1\2'
        backrefs: true
      ignore_errors: true
      notify:
        - reload systemd
        - restart docker

    - name: Remove metrics-addr reference
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/docker.service.d/docker.conf
        regexp: '^(.*)--metrics-addr=0\.0\.0\.0:9323(.*)$'
        line: '\1\2'
        backrefs: true
      ignore_errors: true
      notify:
        - reload systemd
        - restart docker

    - name: Remove experimental reference
      ansible.builtin.lineinfile:
        path: /etc/systemd/system/docker.service.d/docker.conf
        regexp: '^(.*)--experimental=true(.*)$'
        line: '\1\2'
        backrefs: true
      ignore_errors: true
      notify:
        - reload systemd
        - restart docker

    - name: Write daemon.json
      ansible.builtin.copy:
        content: "{{ daemon | to_nice_json }}"
        dest: /etc/docker/daemon.json
        mode: 0644
      notify: restart docker
  tags:
    - rotate

- name: Run notified handler tasks
  ansible.builtin.meta: flush_handlers
