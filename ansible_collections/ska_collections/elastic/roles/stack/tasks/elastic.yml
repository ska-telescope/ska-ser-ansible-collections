---

# https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html
- name: set vm.max_map_count
  sysctl:
    name: vm.max_map_count
    value: "262144"
    state: present
  become: true

- name: Create List of nodes to be added into container's /etc/hosts file
  set_fact:
    masters_etc_hosts: "{{ masters_etc_hosts|default({}) | combine( {item: hostvars[item].ansible_default_ipv4.address} ) }}"
  with_items: "{{ groups[target_hosts]}}"

- name: "Cleans Elasticsearch data volume"
  file:
    path: "{{ stack_data_dir }}"
    state: absent
  when: elastic_clean_data_volume

- name: Elasticsearch config
  template:
    src: elasticsearch.yml.j2
    dest: /etc/elasticsearch.yml
    mode: 0644

- name: Get config file
  command: cat /etc/elasticsearch.yml
  register: result
  when: debug

- name: Print config 
  debug:
    msg: "{{ elastic_config }}"
  when: debug

- name: "Creates directory {{ stack_data_dir }}/elasticsearch"
  file:
    path: "{{ stack_data_dir }}/elasticsearch"
    state: directory
    owner: "{{ ansible_user }}"  # this maps to elasticsearch inside the container
    group: root
    mode: 0755

- name: docker pull elastic image
  docker_image:
    source: pull
    name: "{{ elasticsearch_image }}"
  register: docker_pull_retry
  until: "docker_pull_retry is not failed"
  retries: 5
  delay: 5

- name: Startup Elasticsearch containers
  docker_container:
    name: elk_elasticsearch
    network_mode: "{{ network_mode }}"  # reverse DNS must work
    privileged: "{{ 'yes' if network_mode == 'host' else 'no' }}"
    user: elasticsearch
    memory: "{{ elasticsearch_memory }}"
    hostname: "{{ inventory_hostname }}"
    etc_hosts: "{{ masters_etc_hosts }}"
    restart_policy: false
    image: "{{ elasticsearch_image }}"
    state: started
    ulimits:
      - "memlock:-1:-1"
      - "nofile:65536:65536"
    labels: "{{ container_labels }}"
    log_driver: "{{ log_driver }}"
    log_options: "{{ log_options }}"
    volumes:
      - "{{ stack_data_dir }}/elasticsearch:/usr/share/elasticsearch/data"
      - /etc/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    ports:
      - "9200:9200"
      - "9300:9300"
    env: "{{ node_vars }}"
    recreate: "{{ elastic_reinstall }}"
