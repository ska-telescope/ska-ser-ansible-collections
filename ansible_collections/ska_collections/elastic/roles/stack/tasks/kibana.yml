---

- name: docker pull kibana image
  docker_image:
    source: pull
    name: "{{ kibana_image }}"
  register: docker_pull_retry
  until: "docker_pull_retry is not failed"
  retries: 5
  delay: 5

- name: Kibana config
  template:
    src: kibana.yml.j2
    dest: /etc/kibana.yml
    mode: 0644

- name: Install Kibana Container on Master0
  docker_container:
    name: elk_kibana
    restart_policy: always
    image: "{{ kibana_image }}"
    command: "kibana -e http://{{ ansible_default_ipv4.address }}:9200"  # TODO: change this to point to the elastic cluster
    state: started
    labels: "{{ container_labels }}"
    log_driver: "{{ log_driver }}"
    log_options: "{{ log_options }}"
    volumes:
      - /etc/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    ports:
      - "5601:5601"
    recreate: "{{ kibana_reinstall }}"
