---
- name: "Docker pull {{ kibana_image }}"
  community.general.docker_image:
    source: pull
    name: "{{ kibana_image }}"
  register: docker_pull_retry
  until: "docker_pull_retry is not failed"
  retries: 5
  delay: 5

- name: Create kibana configuration
  ansible.builtin.template:
    src: kibana.yml.j2
    dest: /etc/kibana.yml
    mode: 0644

- name: Run kibana container
  community.general.docker_container:
    name: "{{ kibana_name }}"
    network_mode: "{{ kibana_network_mode }}"  # reverse DNS must work
    privileged: "{{ 'yes' if kibana_network_mode == 'host' else 'no' }}"
    restart_policy: always
    image: "{{ kibana_image }}"
    state: started
    labels: "{{ kibana_labels }}"
    log_driver: "{{ kibana_log_driver }}"
    log_options: "{{ kibana_log_options }}"
    volumes:
      - /etc/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    ports:
      - "{{ kibana_port }}:{{ kibana_port }}"
    recreate: "{{ kibana_reinstall }}"
