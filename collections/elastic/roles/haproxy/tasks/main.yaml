- name: create /etc/ha_config directory
  file:
    path: /etc/hap_config
    state: directory
    mode: 0644

- name: create HAproxy config
  template:
    src: haproxyConfig.j2
    dest: /etc/hap_config/haproxy.cfg
    mode: "0644"
  register: hap_config

- name: "docker pull image for {{ haproxy_container_image }}"
  docker_image:
    source: pull
    name: "{{ haproxy_container_image }}"
  register: hap_image

- name: Get haproxy container info
  docker_container_info:
    name: "{{ haproxy_name }}"
  register: hap_info

- name: run haproxy in a container  # noqa no-handler
  docker_container:
    name: "{{ haproxy_name }}"
    image: "{{ haproxy_container_image }}"
    # restart: true
    recreate: true
    restart_policy: always
    state: started
    privileged: true
    network_mode: host
    exposed_ports:
      - "{{ elasticsearch_port }}"
    labels: "{{ container_labels }}"
    log_driver: "{{ log_driver }}"
    log_options: "{{ log_options }}"
    volumes:
      - /etc/hap_config/:/usr/local/etc/haproxy/
    command: -f /usr/local/etc/haproxy/haproxy.cfg
  when: hap_config.changed or hap_image.changed or not hap_info.exists or not hap_info.container.State.Running
